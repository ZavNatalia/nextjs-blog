---
title: 'Безопасность и Обработка Данных'
date: '2023-10-23'
image: 'how-to-think-about-security-in-next-js.webp'
excerpt: 'React Server Components (RSC) в App Router — это новая парадигма, которая устраняет значительную часть избыточности и потенциальных рисков, связанных с традиционными методами. Из-за новизны подхода разработчикам и, следовательно, командам безопасности может быть сложно адаптировать свои существующие протоколы безопасности к этой модели.'
isFeatured: false
---

React Server Components (RSC) в App Router представляют собой новую парадигму, которая устраняет многие избыточности и потенциальные риски, связанные с традиционными методами. Из-за новизны подхода разработчикам и командам безопасности может быть сложно адаптировать существующие протоколы безопасности к этой модели.

**Основная цель статьи:**

- Выделить ключевые области внимания.
- Описать встроенные механизмы защиты.
- Предоставить руководство по аудиту приложений.
- Особое внимание уделяется рискам случайного раскрытия данных.

## **Выбор Модели Обработки Данных**

Поскольку React Server Components стирают границы между сервером и клиентом, важно правильно понимать, где обрабатывается информация и как она становится доступной. Необходимо выбрать подходящий для вашего проекта метод обработки данных:

1. **HTTP API (Рекомендуется для крупных существующих проектов/организаций):**

    - Рассматривайте Server Components как небезопасные по умолчанию, подобно SSR или клиентскому коду.
    - Используйте _fetch()_ для вызова собственных API-эндпоинтов (REST или GraphQL), передавая необходимые куки.
    - Помогает сохранить существующие организационные структуры и применять текущие практики безопасности.

2. **Слой Доступа к Данным (Рекомендуется для новых проектов):**

    - Создайте отдельный слой доступа к данным внутри вашего JavaScript-кода.
    - Объедините всю работу с данными в одном месте для обеспечения согласованности и уменьшения вероятности ошибок авторизации.
    - Упростите обслуживание и улучшите производительность благодаря общему кэшу в памяти.

3. **Доступ к Данным на Уровне Компонента (Рекомендуется для прототипирования и обучения):**
    - Прямое использование запросов к базе данных внутри Server Components.
    - Подходит только для быстрого прототипирования и небольших команд, осознающих риски.
    - Требует тщательного аудита клиентских компонентов (_"use client"_), чтобы предотвратить утечку данных.

**Рекомендация:** Выберите один подход и придерживайтесь его, чтобы обеспечить ясность для разработчиков и аудиторов безопасности.

## Практики Безопасности

![Illustration of HTTP APIs and Zero Trust for a Next.js project](http-apis-and-zero-trust-in-the-context-of-server-components.webp)

1. **Маркировка Кода "Server Only":**

    - Используйте _import 'server-only';_ в модулях, которые должны выполняться только на сервере.
    - Предотвращает случайное включение чувствительного кода в клиентскую сборку.

2. **Валидация Пользовательского Ввода:**

    - Всегда проверяйте входные данные, особенно при использовании _params_, _searchParams_ и _headers_.
    - Не доверяйте данным, полученным из URL или других источников, контролируемых клиентом.

3. **Избегайте Сайд-Эффектов при Рендеринге:**

    - Рендеринг Server Components не должен вызывать мутации или изменения состояния.
    - Для изменений используйте **Server Actions**.

4. **Использование Server Actions для Мутаций:**

    - Объявляйте серверные действия с помощью _"use server"_.
    - Всегда проверяйте права доступа пользователя внутри действий.
    - Валидируйте все аргументы функций.

5. **Обработка Ошибок:**
    - В продакшене React не передаёт подробные сообщения об ошибках на клиент, чтобы предотвратить утечку чувствительной информации.
    - Убедитесь, что приложение запускается в режиме продакшена в рабочих средах.

## **CSRF Защита и Безопасность Действий**

1. **Server Actions и CSRF:**

    - Server Actions вызываются через POST-запросы, что предотвращает большинство CSRF-атак благодаря политике Same-Site для куки.
    - Дополнительно проверяется заголовок Origin на совпадение с Host, и при несоответствии запрос отклоняется.

2. **Custom Route Handlers и Middleware:**
    - Эти механизмы предоставляют большой уровень контроля, но требуют тщательного аудита и реализации дополнительных мер безопасности.

## **Рекомендации по Аудиту**

![Abstract 3D representations of the audit process for a Next.js App Router project](audit-of-a-Next-js-App-Router-project.webp)

При аудите проекта Next.js с использованием App Router обратите внимание на следующие аспекты:

1. **Слой Доступа к Данным:**

    - Убедитесь, что существует чётко определённый слой доступа к данным.
    - Проверьте, что пакеты для работы с базами данных и переменные окружения не используются вне этого слоя.

2. **Клиентские Компоненты (_"use client"_):**

    - Проверьте интерфейсы пропсов на предмет передачи приватных данных.
    - Убедитесь, что компоненты принимают только необходимые данные.

3. **Серверные Действия (_"use server"_):**

    - Убедитесь, что аргументы действий валидируются внутри функции.
    - Проверьте, что права доступа пользователя проверяются при каждом вызове действия.

4. **Динамические Маршруты (_/[param]/_):**

    - Параметры маршрутов являются пользовательским вводом и должны быть тщательно валидированы.

5. **Middleware и Route Handlers:**
    - Эти файлы имеют большой потенциал влияния на безопасность и требуют особого внимания.
    - Регулярно проводите тестирование на проникновение и сканирование уязвимостей в соответствии с жизненным циклом разработки вашего ПО.

## **Заключение**

Новая модель React Server Components в Next.js предоставляет мощные возможности, но требует внимательного подхода к безопасности и обработке данных. Соблюдение рекомендуемых практик и регулярный аудит помогут обеспечить безопасность приложения и предотвратить случайное раскрытие данных.

---

_Автор [оригинального поста](https://nextjs.org/blog/security-nextjs-server-components-actions) Sebastian Markbåge_
